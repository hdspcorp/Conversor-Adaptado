<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conversor</title>
  <style>
   :root{
  /* Padr√£o corporativo: grafite + verde suave */
  --bg:#0b1016;        /* fundo principal (menos azulado) */
  --fg:#d8dee6;        /* texto principal (menos branco) */
  --muted:#98a3b0;     /* texto secund√°rio mais discreto */
  --acc:#94A3B8;       /* slate-400 (cinza-azulado desaturado) */
  --card:#0e141b;      /* cart√µes/espa√ßos internos */
  --border:#1c2733;    /* bordas discretas */
}
header .note{
  display:block;              /* responsivo */
  margin: 6px 0 0 0;
  font-size: 13px;
  color: var(--muted);
  opacity:.9
}
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--fg); }
    header { padding:20px 24px; border-bottom:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0)); position:relative; }
    h1 { margin:0; font-size:22px; }
    main { max-width:1100px; margin:0 auto; padding:24px; }
    .grid { display:grid; gap:16px; grid-template-columns: repeat(12, 1fr); }
    .col-6 { grid-column: span 6; }
    .col-12 { grid-column: span 12; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.22); }
    .card h2 { margin:0 0 12px; font-size:18px; }
    label { display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
    input[type="number"], select, input[type="text"], textarea { width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#121824; color:var(--fg); }
    .btn { cursor:pointer; border:none; border-radius:12px; padding:10px 14px; background:var(--acc); color:#0b1016; font-weight:700; transition: filter .12s ease, transform .12s ease; }
    .btn:hover { filter: brightness(1.04); transform: translateY(-0.5px); }
    .btn:active { filter: brightness(0.98); transform: translateY(0); }
    .btn.ghost { background:#1a2330; color:var(--fg); }
    .btn.ghost:hover { filter: brightness(1.06); transform: translateY(-0.5px); }
    .btn.ghost:active { filter: brightness(0.98); transform: translateY(0); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .list { max-height:220px; overflow:auto; border:1px solid var(--border); border-radius:12px; padding:10px; background:#121824; font-size:12px; }
    .stats { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; margin-top:10px; }
    .stat { background:#121824; border:1px solid var(--border); border-radius:12px; padding:10px; font-size:13px; color:var(--muted); }
    .stat strong { display:block; font-size:16px; color:var(--fg); }
    .bar { height:10px; background:#121824; border:1px solid rgba(255,255,255,.05); border-radius:999px; overflow:hidden; }
    .bar > div { height:100%; width:0%; background:linear-gradient(90deg, #94A3B8, #CBD5E1); }
    pre { white-space: pre-wrap; background:#121824; border:1px solid var(--border); border-radius:12px; padding:12px; font-size:12px; }
    .downloads a { display:inline-block; margin:6px 6px 0 0; padding:8px 10px; background:#1b2430; border:1px solid var(--border); border-radius:8px; color:var(--fg); text-decoration:none; font-size:13px; box-shadow: 0 4px 10px rgba(0,0,0,.18); }
    .pill { font-size:11px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#121824; color:var(--muted); }
    small { color:var(--muted); }

   /* Segmented control (modo de sa√≠da) ‚Äî destaque premium */
.seg-wrap { display:flex; gap:10px; flex-wrap:wrap; }
.seg {
  display:inline-flex; align-items:center; cursor:pointer; user-select:none;
  padding:10px 14px; border-radius:14px;
  background:#121824; border:1px solid var(--border);
  box-shadow: 0 6px 18px rgba(0,0,0,.25);
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
}
.seg:hover{ transform: translateY(-1px); box-shadow:0 10px 24px rgba(0,0,0,.28); }
.seg input{ display:none; }
.seg span{ font-size:14px; font-weight:600; color:var(--muted); letter-spacing:.2px; }

.seg input:checked + span{
  color:#0b1220;
  background: linear-gradient(135deg, #CBD5E1 0%, #94A3B8 100%); /* slate claro ‚Üí slate m√©dio */
  -webkit-background-clip:text; -webkit-text-fill-color:transparent;
}
.seg:has(input:checked){
  border-color: #94A3B8;
  box-shadow: 0 8px 26px rgba(148,163,184,.22), inset 0 1px 0 rgba(255,255,255,.08);
}

    .muted { color:var(--muted); font-size:12px; }
    .dim { opacity:.6; pointer-events:none; filter:saturate(.7); }

	/* ‚Äî‚Äî‚Äî App Switcher: bot√£o + menu dropdown ‚Äî‚Äî‚Äî */
.app-switcher {
  position: absolute;
  right: 16px;
  top: 16px;
  z-index: 1000;
}
.app-switcher__btn {
  border: 1px solid var(--border, rgba(255,255,255,.15));
  background: linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  color: var(--fg, #e5e7eb);
  padding: 8px 12px;
  border-radius: 12px;
  font-weight: 700;
  letter-spacing: .2px;
  cursor: pointer;
  box-shadow: 0 8px 24px rgba(0,0,0,.25);
  backdrop-filter: blur(6px);
}
.app-switcher__btn:hover { transform: translateY(-1px); }
.app-switcher__menu {
  position: absolute;
  right: 0;
  margin-top: 8px;
  min-width: 260px;
  padding: 8px;
  border-radius: 14px;
  border: 1px solid var(--border, rgba(255,255,255,.12));
  background: linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.95));
  box-shadow: 0 20px 40px rgba(0,0,0,.35);
  display: none;
}
.app-switcher.open .app-switcher__menu { display: block; }

.app-switcher__item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 10px; border-radius: 10px; text-decoration: none;
  color: var(--fg, #e5e7eb);
  border: 1px solid transparent;
}
.app-switcher__item small { color: var(--muted, #9aa4b2); display:block; margin-top:2px }
.app-switcher__item:hover {
  background: rgba(255,255,255,.04);
  border-color: rgba(255,255,255,.08);
}

/* === Ajuda flutuante (FAB) canto inferior direito === */
.help-fab{
  position: fixed;
  right: 18px;
  bottom: 18px;
  z-index: 30000;
}

.help-hint{
  position: relative;
  display: inline-flex;
  justify-content: center;
  align-items: center;
  width: 36px; height: 36px;
  border-radius: 50%;
  background: var(--acc);
  color: #0b1016;
  font-weight: 800;
  cursor: pointer;
  box-shadow: 0 8px 24px rgba(0,0,0,.35);
}
.help-hint:focus{ outline: 2px solid rgba(255,255,255,.25); outline-offset: 3px; }

/* Pop-up compacto, abre para CIMA */
.help-bubble{
  position: absolute;
  bottom: calc(100% + 12px);
  right: 0;
  left: auto;

  /* largura confort√°vel e limites de viewport */
  width: min(560px, 94vw);
  min-width: 360px;
  max-height: min(76vh, 620px);
  overflow: auto;

  background: var(--card);
  /* texto neutro, chamativo mas suave (opacidade) */
  color: #d8dee6CC;

  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;

  box-shadow: 0 18px 40px rgba(0,0,0,.45);
  display: none;
  z-index: 1;

  /* >>> chave para tirar o negrito herdado do .help-hint <<< */
  font-weight: 400;

  /* leitura */
  font-size: 12px;
  line-height: 1.5;
  overflow-wrap: anywhere;
  word-break: break-word;
}

/* Tipografia do conte√∫do interno (compacta e hier√°rquica) */
/* T√≠tulo e subt√≠tulo em destaque (cor ‚Äúcheia‚Äù no t√≠tulo) */
.help-bubble .hb-title{
  font-weight: 700;         /* negrito s√≥ aqui */
  font-size: 13px;
  letter-spacing: .2px;
  margin: 0 0 8px 0;
  color: var(--fg);
}
.help-bubble .hb-section{
  margin: 10px 0 12px 0;
}
.help-bubble .hb-section .hb-sub{
  font-weight: 600;         /* semi-negrito s√≥ no subt√≠tulo */
  margin-bottom: 4px;
  color: #d8dee6E6;         /* levemente mais forte que o corpo */
}

/* Corpo do texto: sem negrito */
.help-bubble p{ margin: 4px 0 6px 0; }
.help-bubble ul{ margin: 6px 0 6px 16px; padding: 0; }
.help-bubble li{ margin-bottom: 4px; }
.help-bubble .hb-flow{
  margin-top: 10px;
  font-weight: 400;         /* sem negrito no rodap√© */
}

/* Remove negrito de qualquer <strong>/<b> no corpo das se√ß√µes */
.help-bubble .hb-section strong,
.help-bubble .hb-section b{
  font-weight: 400 !important;
}

/* Exibir em hover/foco */
.help-hint:hover .help-bubble,
.help-hint:focus .help-bubble,
.help-hint:focus-within .help-bubble{
  display: block;
}

/* Mobile: posicionamento confort√°vel */
@media (max-width: 520px){
  .help-fab{ right: 12px; bottom: 12px; }
  .help-bubble{
    right: -6px;
    max-width: calc(100vw - 24px);
  }
}
  </style>

  <!-- PDF e DOCX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script> if (window['pdfjsLib']) pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js'; </script>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
</head>
<body>
  <header>
    <h1>Conversor</h1>
	<nav class="app-switcher" aria-label="Outros aplicativos">
  <button id="appSwitcherBtn" class="app-switcher__btn" type="button">HDSP CORP ‚ñæ</button>
  <div id="appSwitcherMenu" class="app-switcher__menu" role="menu">
    <a class="app-switcher__item" role="menuitem" href="https://hdspcorp.github.io/curadoriapro10/" target="_blank" rel="noopener">
      <div>
        <strong>Analisador</strong>
        <small>Importa JSON e envia os grupos para avalia√ß√£o</small>
      </div>
    </a>
    <a class="app-switcher__item" role="menuitem" href="https://hdspcorp.github.io/poscuradoria/" target="_blank" rel="noopener">
      <div>
        <strong>Workspace</strong>
        <small>Visualiza, e filtra as avalia√ß√µes do agente de Curadoria</small>
      </div>
    </a>
  </div>
</nav>
	<span class="note"><b>Dica Importante galera:</b> no Chrome/Edge, se voc√™s clicarem em Baixar Todos, ele pergunta qual pasta voc√™s desejam salvar. (Humberto) </span>
  </header>

  <main>
    <div class="grid">

      <!-- CONFIG -->
      <section class="card col-6">
       <h2>Configura√ß√£o</h2>

<!-- 1) Modo de sa√≠da ‚Äî ‚ÄúGerar PACKS‚Äù como principal e default -->
<label class="muted"></label>
<div class="seg-wrap" style="margin-bottom:8px">
  <label class="seg"><input type="radio" name="outmode" id="modePacks" checked><span>Gerar PACKS</span></label>
  <label class="seg"><input type="radio" name="outmode" id="modeIndividual"><span>Converter para TXT (1:1)</span></label>
</div>
<small class="muted"></small>

<!-- 2) Op√ß√µes gerais -->
<div class="row" style="margin-top:12px">
  <!-- <label><input id="stripHtml" type="checkbox" /> Remover tags HTML de arquivos .html</label> -->
  <label><input id="preserveOrder" type="checkbox" checked /> Preservar ordem por nome</label>
  <!-- <label><input id="optimizeMd" type="checkbox" /> Otimizar para IA (Markdown + metadados)</label> -->
</div>

<!-- 3) Op√ß√µes para PACKS -->
<div style="margin-top:12px">
  <label class="muted"></label>
  <div class="row">
    <div style="flex:1; min-width:200px">
      <label for="packs">N√∫mero de packs</label>
      <input id="packs" type="number" min="1" max="40" value="1" list="packsList" />
      <datalist id="packsList"></datalist>
    </div>
    <div style="flex:1; min-width:200px">
      <label for="startIndex">Iniciar numera√ß√£o em</label>
      <input id="startIndex" type="number" min="1" value="1" />
    </div>
    <div style="flex:1; min-width:180px">
      <label for="ext">Extens√£o de sa√≠da</label>
      <select id="ext">
        <option value="txt" selected>.txt</option>
        <option value="md">.md</option>
      </select>
    </div>
  </div>

  <div style="margin-top:10px">
    <label for="sepPreset">Separador entre documentos</label>
    <div class="row">
      <select id="sepPreset" style="flex:1; min-width:220px">
        <option value="blank2">2 linhas em branco</option>
        <option value="dash">Linha horizontal (---)</option>
        <option value="hash" selected>## FIM DO DOCUMENTO ##</option>
        <option value="none">Nenhum separador</option>
      </select>
      <input id="sepCustom" type="text" placeholder="Personalizado (se preencher, substitui o selecionado)" style="flex:2; min-width:260px" />
    </div>
    <small class="muted"></small>
  </div>
</div>

<!-- 4) A√ß√µes e Progresso -->
<div class="row" style="margin-top:14px">
  <button id="btnProcess" class="btn">Gerar</button>
  <button id="btnReset" class="btn ghost">Limpar</button>
</div>
<div style="margin-top:12px">
  <div class="bar"><div id="progress"></"></div></div>
  <div id="status" class="pill" style="margin-top:6px">Aguardando sele√ß√£o‚Ä¶</div>
</div>
      </section>
	  
      <!-- ARQUIVOS -->
      <section class="card col-6">
                <h2>Arquivos</h2>
        <div class="row">
          <button id="btnPickFiles" class="btn">Selecionar arquivos</button>
          <button id="btnPickFolder" class="btn ghost">Selecionar pasta</button>
          <button id="btnROSILANE" class="btn">EXPORTAR ROSILANE</button>
          <span class="pill">Suporta: .txt .md .csv .json .log .html .htm .pdf .docx</span>
        </div>
        <input id="fileInputFiles" type="file" multiple style="display:none" accept=".txt,md,csv,json,log,html,htm,pdf,docx,doc" />
        <input id="fileInputDir" type="file" multiple style="display:none" webkitdirectory directory accept=".txt,md,csv,json,log,html,htm,pdf,docx,doc" />
        <input id="ROSILANEInput" type="file" style="display:none" accept=".json" />
        <div id="fileList" class="list" style="margin-top:12px"></div>
        <div class="stats">
          <div class="stat"><span>Total de arquivos</span><strong id="statFiles">0</strong></div>
          <div class="stat"><span>Tamanho total (MB)</span><strong id="statSize">0</strong></div>
          <div class="stat"><span>Caracteres (aprox.)</span><strong id="statChars">0</strong></div>
          <div class="stat"><span>Tokens (‚âà chars/4)</span><strong id="statTokens">0</strong></div>
        </div>
      </section>

      <section class="card col-12">
        <h2>Downloads</h2>
        <div class="row" style="margin: 0 0 8px 0">
          <button id="btnDownloadAll" class="btn ghost" disabled>Baixar todos</button>
        </div>
        <div id="downloads" class="downloads"></div>
      </section>

      <section class="card col-12">
        <h2>Pr√©-visualiza√ß√£o do primeiro resultado</h2>
        <pre id="preview">(vazio)</pre>
      </section>
    </div>
  </main>

  <!-- Ajuda flutuante (canto inferior direito) -->
  <div class="help-fab">
    <span class="help-hint" tabindex="0" aria-label="Ajuda: passo a passo" role="button">?
      <div class="help-bubble" role="dialog" aria-modal="false">
        <div class="hb-title">üß† Passo a passo da Curadoria</div>

        <div class="hb-section">
          <div class="hb-sub">1. Conversor ‚Äî Preparar os Arquivos</div>
          <p>Use este programa para converter documentos da base da Kiara (como DOCX, PDF, RTF, etc.) para o formato .TXT.<br>
          Isso permite padronizar os conte√∫dos e facilitar o envio para o Agente de Curadoria.</p>
          <p><strong>üí° Recomenda√ß√µes:</strong></p>
          <ul>
            <li>Converta apenas os documentos realmente √∫teis para o treinamento ou avalia√ß√£o.</li>
            <li>Tente agrupar informa√ß√µes em menos arquivos, evitando centenas de arquivos pequenos.</li>
            <li>Ap√≥s a convers√£o, os arquivos .TXT estar√£o prontos para subir na Base de Dados do Agente de Curadoria.</li>
          </ul>
        </div>

        <div class="hb-section">
          <div class="hb-sub">2. Transmissor ‚Äî Enviar as Intera√ß√µes para Avalia√ß√£o</div>
          <p>Neste programa voc√™ ir√° transmitir as intera√ß√µes (perguntas e respostas da Kiara) que ser√£o avaliadas.</p>
          <p><strong>O que voc√™ precisa informar:</strong></p>
          <ul>
            <li>ID do Bot de Curadoria (obrigat√≥rio)</li>
            <li>Chave de API (<strong>‚ö†Ô∏è NUNCA</strong> compartilhe essa chave com terceiros ou exponha em lugares p√∫blicos)</li>
          </ul>
          <p><strong>Como funciona:</strong></p>
          <p>Ap√≥s preencher os dados e importar o JSON com as intera√ß√µes do dia, clique em <em>ENVIAR</em>.<br>
          O Agente de Curadoria receber√° os dados e dar√° in√≠cio autom√°tico √† avalia√ß√£o de cada resposta da Kiara.</p>
          <p><strong>üìÖ Dica:</strong> idealmente, transmita as intera√ß√µes do mesmo dia em que ser√° feita a curadoria.</p>
        </div>

        <div class="hb-section">
          <div class="hb-sub">3. Workspace ‚Äî Visualizar as Avalia√ß√µes</div>
          <p>Depois que o Agente de Curadoria processar os dados, ele ir√° gerar um arquivo .JSON com as classifica√ß√µes de cada resposta da Kiara.</p>
          <p><strong>O que voc√™ pode fazer no Workspace:</strong></p>
          <ul>
            <li>Importar os arquivos de retorno (.JSON).</li>
            <li>Visualizar todas as avalia√ß√µes feitas.</li>
            <li>Filtrar por classifica√ß√£o: ‚úÖ Correta ¬∑ ‚ùå Incorreta ¬∑ ‚ö†Ô∏è Falta de Documenta√ß√£o.</li>
          </ul>
          <p>üîé Com os filtros, voc√™ consegue revisar rapidamente onde a IA foi bem e onde precisa de ajustes na base.</p>
        </div>

        <div class="hb-flow">‚úÖ Fluxo ideal de uso ‚Äî ‚û°Ô∏è Conversor ‚Üí Transmissor ‚Üí Workspace</div>
      </div>
    </span>
  </div>

  <script>
    const els = {
  btnPickFiles: document.getElementById('btnPickFiles'),
  btnPickFolder: document.getElementById('btnPickFolder'),
  fileInputFiles: document.getElementById('fileInputFiles'),
  fileInputDir: document.getElementById('fileInputDir'),
  fileList: document.getElementById('fileList'),
  statFiles: document.getElementById('statFiles'),
  statSize: document.getElementById('statSize'),
  statChars: document.getElementById('statChars'),
  statTokens: document.getElementById('statTokens'),
  packs: document.getElementById('packs'),
  startIndex: document.getElementById('startIndex'),
  ext: document.getElementById('ext'),
  /* stripHtml: document.getElementById('stripHtml'), */   // comentado, mantido
  preserveOrder: document.getElementById('preserveOrder'),
  sepPreset: document.getElementById('sepPreset'),
  sepCustom: document.getElementById('sepCustom'),
  /* optimizeMd: document.getElementById('optimizeMd'), */ // comentado, mantido
  btnProcess: document.getElementById('btnProcess'),
  btnReset: document.getElementById('btnReset'),
  progress: document.getElementById('progress'),
  status: document.getElementById('status'),
  downloads: document.getElementById('downloads'),
  preview: document.getElementById('preview'),
  btnDownloadAll: document.getElementById('btnDownloadAll'),
  modePacks: document.getElementById('modePacks'),
  modeIndividual: document.getElementById('modeIndividual'),
  /* ‚Äî‚Äî novos ‚Äî‚Äî */
  btnROSILANE: document.getElementById('btnROSILANE'),
  ROSILANEInput: document.getElementById('ROSILANEInput'),
};

  (function fillPacksDatalist(){
    const dl = document.getElementById('packsList');
    for(let i=1;i<=40;i++){
      const opt = document.createElement('option');
      opt.value = String(i);
      dl.appendChild(opt);
    }
  })();

  let selectedFiles = [];
  let generatedPacksData = [];
  const ALLOWED_EXT = ['.txt','.md','.csv','.json','.log','.html','.htm','.pdf','.docx','.doc'];

  function fmtMB(bytes){ return (bytes/1024/1024).toFixed(2); }
  function approxTokens(chars){ return Math.round(chars/4); }
  function baseName(fileName){ const i = fileName.lastIndexOf('.'); return i>0 ? fileName.slice(0,i) : fileName; }
  function hasAllowedExt(name){ const lower = name.toLowerCase(); return ALLOWED_EXT.some(ext => lower.endsWith(ext)); }

  // ===== Preservar quebras de linha ao extrair texto de HTML =====
  function htmlToTextPreserveBreaks(html){
    const doc = new DOMParser().parseFromString(html || '', 'text/html');
    const body = doc.body || doc.createElement('body');

    // <br> -> \n
    body.querySelectorAll('br').forEach(br => br.replaceWith(doc.createTextNode('\n')));

    // Elementos de bloco recebem quebras antes/depois
    const blockSel = 'p,div,li,section,article,header,footer,pre,blockquote,hr,h1,h2,h3,h4,h5,h6,table,tr,ul,ol,dd,dt,figure,figcaption';
    body.querySelectorAll(blockSel).forEach(el=>{
      el.insertAdjacentText('beforebegin','\n');
      el.insertAdjacentText('afterend','\n');
    });

    let text = body.textContent || '';

    // Normaliza \r\n -> \n
    text = text.replace(/\r\n?/g, '\n');

    // Reduz excesso de linhas em branco consecutivas para no m√°x. 2
    text = text.replace(/\n{3,}/g, '\n\n');

    // N√ÉO dar trim global
    return text.replace(/[ \t]+\n/g, '\n').replace(/[ \t]+$/,'');
  }

  // ===== Utilit√°rios opcionais (mantidos no c√≥digo, mas **n√£o usados** porque a op√ß√£o foi comentada) =====
  function slugify(s){
    return (s || '')
      .normalize('NFKD')
      .replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-zA-Z0-9]+/g,'-')
      .replace(/^-+|-+$/g,'')
      .toLowerCase();
  }
  function detectTagsFromName(name){
    const tags = [];
    const n = (name || '').toLowerCase();
    if(n.includes('ngfiscal')) tags.push('NGFiscal');
    if(n.includes('ngcontabil')) tags.push('NGContabil');
    if(n.includes('ngfolha') || n.includes('hcm')) tags.push('HCM');
    if(n.includes('keevocenter') || n.includes('keevo center')) tags.push('KeevoCenter');
    return tags.length ? tags : ['documento'];
  }
  function addFrontMatter({docId, title, source, tags}){
    const created = new Date().toISOString().slice(0,10);
    const yaml =
`---
doc_id: "${docId}"
title: "${title}"
source: "${source}"
created_at: "${created}"
tags: [${tags.map(t=>`"${t}"`).join(', ')}]
---

`;
    return yaml;
  }
  function promoteSectionHeadings(raw){
    const SECTION_HINTS = [
      'introdu√ß√£o','quando utilizar','quando usar','como utilizar','como usar',
      'passo a passo','procedimento','processo','campos','par√¢metros','parametros',
      'observa√ß√µes','observacoes','requisitos','perguntas e respostas','faq','exemplos',
      'confer√™ncia','conferencia','relat√≥rios','relatorios','erros comuns','solu√ß√£o de problemas'
    ];
    const lines = raw.split('\n');
    return lines.map((line) => {
      const trimmed = line.trim();
      if (!trimmed || /^#{1,6}\s/.test(trimmed) || /^(-|\*|\‚Ä¢|\d+\.)\s/.test(trimmed) || trimmed.length > 80) {
        return line;
      }
      const lower = trimmed.toLowerCase();
      if (SECTION_HINTS.includes(lower)) return (line.startsWith('## ') ? line : `## ${trimmed}`);
      if (/:$/.test(trimmed) && trimmed.length <= 60) {
        const noColon = trimmed.replace(/:$/,'');
        return (line.startsWith('## ') ? line : `## ${noColon}`);
      }
      return line;
    }).join('\n');
  }
  function normalizeBullets(raw){
    return raw
      .replace(/^\s*[‚Ä¢\*]\s+/gm, '- ')
      .replace(/^\s*-\s{2,}/gm, '- ');
  }

  function ensureLf(raw){ return raw.replace(/\r\n?/g, '\n'); }
  function enforceMaxBlankLines(raw){ return raw.replace(/\n{3,}/g, '\n\n'); }

  // Ordena√ß√£o natural com prefixos num√©ricos
  function splitNumericPrefix(n){
    const base = n.replace(/^.*[\\/]/,'');
    const m = base.match(/^\s*(\d+(?:\.\d+)*)(?=\s|[-_.])/);
    if(!m) return null;
    return m[1].split('.').map(v=>parseInt(v,10));
  }
  function cmpByVersionedName(aName, bName){
    const aNums = splitNumericPrefix(aName);
    const bNums = splitNumericPrefix(bName);
    if(aNums && bNums){
      const len = Math.max(aNums.length, bNums.length);
      for(let i=0;i<len;i++){
        const av = (i < aNums.length) ? aNums[i] : 0;
        const bv = (i < bNums.length) ? bNums[i] : 0;
        if(av !== bv) return av - bv;
      }
      return aName.localeCompare(bName, undefined, {sensitivity:'base', numeric:true});
    }
    if(aNums) return -1;
    if(bNums) return 1;
    return aName.localeCompare(bName, undefined, {sensitivity:'base', numeric:true});
  }

  // ========= UI base =========
  els.btnPickFiles.addEventListener('click', ()=> els.fileInputFiles.click());
  els.btnPickFolder.addEventListener('click', ()=> els.fileInputDir.click());
  els.fileInputFiles.addEventListener('change', handleSelection);
  els.fileInputDir.addEventListener('change', handleSelection);

  function handleSelection(){
    const files = Array.from(this.files || []);
    const filtered = files.filter(f => hasAllowedExt(f.name));
    selectedFiles = mergeFileLists(selectedFiles, filtered);
    renderFileList();
  }
  function mergeFileLists(prev, add){
    const map = new Map();
    for(const f of prev){ map.set((f.webkitRelativePath||f.name)+':'+f.size, f); }
    for(const f of add){ map.set((f.webkitRelativePath||f.name)+':'+f.size, f); }
    return Array.from(map.values());
  }
  function renderFileList(){
    els.fileList.innerHTML = '';
    if(!selectedFiles.length){
      els.statFiles.textContent = '0'; els.statSize.textContent = '0'; els.statChars.textContent = '0'; els.statTokens.textContent = '0';
      els.status.textContent = 'Aguardando sele√ß√£o‚Ä¶';
      return;
    }
    let totalSize = 0;
    const ul = document.createElement('ul'); ul.style.listStyle = 'none'; ul.style.padding = 0; ul.style.margin = 0;
    selectedFiles.sort((a,b)=> cmpByVersionedName(a.name, b.name));
    selectedFiles.forEach((f,idx)=>{ totalSize += f.size; if(idx<300){ const li=document.createElement('li'); li.textContent=(f.webkitRelativePath||f.name); ul.appendChild(li);} });
    if(selectedFiles.length>300){ const li=document.createElement('li'); li.textContent=`‚Ä¶ (+${selectedFiles.length-300} mais)`; ul.appendChild(li);}    
    els.fileList.appendChild(ul);
    els.statFiles.textContent = String(selectedFiles.length);
    els.statSize.textContent = fmtMB(totalSize);
    els.statChars.textContent = '‚Äî';
    els.statTokens.textContent = '‚Äî';
    els.status.textContent = 'Pronto para processar';
  }

  // ========= Extractors =========
  async function extractPdfText(file){
    const arrayBuffer = await file.arrayBuffer();
    if(!window.pdfjsLib){ throw new Error('PDF.js n√£o carregado'); }
    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
    let text = '';
    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const tc = await page.getTextContent();
      const pageText = tc.items.map(i => (i.str || '')).join(' ');
      text += pageText + '\n\n';
    }
    return text;
  }
  async function extractDocxText(file){
    const arrayBuffer = await file.arrayBuffer();
    if(!window.mammoth){ throw new Error('Mammoth (DOCX) n√£o carregado'); }
    const result = await window.mammoth.convertToHtml({arrayBuffer});
    const html = result.value || '';
    return htmlToTextPreserveBreaks(html);
  }
  async function readFileAsText(file){
    const lower = file.name.toLowerCase();
    if(lower.endsWith('.pdf')){ return await extractPdfText(file); }
    if(lower.endsWith('.docx')){ return await extractDocxText(file); }
    if(lower.endsWith('.doc')){ throw new Error('Arquivo .DOC n√£o suportado no navegador: '+file.name+' ‚Äî converta para .DOCX/.PDF/.TXT.'); }

    const raw = await file.text();

    if(/\.(html?|HTML?)$/.test(file.name)){
      /* if(els.stripHtml.checked){  // comentado
        return htmlToTextPreserveBreaks(raw);
      } else { */
        return raw;
      /* } */
    }
    return raw; // TXT/MD/CSV/JSON/LOG
  }

  // ========= Helpers =========
  function getSeparator(){
    const custom = (els.sepCustom.value || '').trim();
    if(custom) return decodeEscapes(custom);
    switch(els.sepPreset.value){
      case 'dash': return '\n\n---\n\n';
      case 'hash': return '\n\n## FIM DO DOCUMENTO ##\n\n';
      case 'none': return '\n';
      case 'blank2':
      default: return '\n\n';
    }
  }
  function decodeEscapes(s){ return s.replace(/\\n/g, '\n').replace(/\\t/g, '\t').replace(/\\r/g, '\r'); }
  function assignDocsToPacksSequential(docs, k){
    const lengths = docs.map(d=>d.len);
    const total = lengths.reduce((a,b)=>a+b,0);
    const target = Math.ceil(total / k);
    const packs = Array.from({length:k}, () => ({docs:[], len:0}));
    let idx = 0;
    for(const d of docs){
      if(idx < k-1 && (packs[idx].len + d.len) > target){ idx++; }
      packs[idx].docs.push(d);
      packs[idx].len += d.len;
    }
    return packs;
  }
  function download(filename, text){
    const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.style.display='none';
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);
  }
  function createDownloadLink(fname, text){
    const a = document.createElement('a');
    a.href = '#';
    a.textContent = fname;
    a.addEventListener('click', (ev)=>{ ev.preventDefault(); download(fname, text); });
    els.downloads.appendChild(a);
    generatedPacksData.push({ fname, text });
  }

  // ========= ‚ÄúBaixar todos‚Äù & Reset =========
 els.btnDownloadAll.addEventListener('click', async () => {
  if(!generatedPacksData.length){ alert('Nada para baixar.'); return; }

  els.btnDownloadAll.disabled = true;
  const originalText = els.btnDownloadAll.textContent;

  try {
    if ('showDirectoryPicker' in window) {
      // Chrome/Edge: escolher pasta e salvar arquivos diretamente
      els.btnDownloadAll.textContent = 'Escolhendo pasta‚Ä¶';
      const dirHandle = await window.showDirectoryPicker({ mode: 'readwrite' });

      els.btnDownloadAll.textContent = 'Salvando na pasta‚Ä¶';
      for (const p of generatedPacksData) {
        const fileHandle = await dirHandle.getFileHandle(p.fname, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(p.text);
        await writable.close();
      }
      alert('Arquivos salvos com sucesso na pasta escolhida.');
    } else {
      // Outros navegadores: baixa todos via downloads tradicionais
      els.btnDownloadAll.textContent = 'Baixando todos‚Ä¶';
      for (const p of generatedPacksData) {
        download(p.fname, p.text);
        await new Promise(r=>setTimeout(r, 120));
      }
    }
  } catch (err) {
    console.error(err);
    alert('N√£o foi poss√≠vel salvar/baixar: ' + (err.message || err));
  } finally {
    els.btnDownloadAll.disabled = false;
    els.btnDownloadAll.textContent = originalText;
  }
});

  els.btnReset.addEventListener('click', ()=>{
    els.fileInputFiles.value = '';
    els.fileInputDir.value = '';
    selectedFiles = [];
    generatedPacksData = [];
    els.downloads.innerHTML = '';
    els.preview.textContent = '(vazio)';
    els.progress.style.width = '0%';
    els.btnDownloadAll.disabled = true;
    renderFileList();
  });

  // ========= Modo de sa√≠da: habilitar/desabilitar campos =========
  function syncModeUI(){
    const individual = els.modeIndividual.checked;
    // packs-only
    els.packs.disabled    = individual;
    els.sepPreset.disabled= individual;
    els.sepCustom.disabled= individual;
    els.startIndex.disabled = individual;
    // extens√£o: no modo individual, for√ßamos .txt
    els.ext.disabled      = individual;
    if (individual) { els.ext.value = 'txt'; }
    // cosmetics
    [els.packs, els.sepPreset, els.sepCustom, els.ext, els.startIndex].forEach(el=>{
      el.closest('div')?.classList.toggle('dim', individual && (el===els.packs || el===els.sepPreset || el===els.sepCustom || el===els.startIndex));
    });
  }
    els.modePacks.addEventListener('change', syncModeUI);
  els.modeIndividual.addEventListener('change', syncModeUI);
  syncModeUI(); // default j√° entra em PACKS

  // ========= EXPORTAR ROSILANE =========
  (function(){
    const { btnROSILANE, ROSILANEInput } = els;
    if(!btnROSILANE || !ROSILANEInput) return;

    btnROSILANE.addEventListener('click', ()=> ROSILANEInput.click());

    ROSILANEInput.addEventListener('change', async (ev)=>{
      try{
        const file = ev.target.files && ev.target.files[0];
        if(!file){ return; }

        const text = await file.text();
        const data = JSON.parse(text);

                const rows = (data.conversations || []).map(c => {
          // user_id: manter somente o que est√° ANTES do ponto
          const rawU = (c && typeof c.user_id !== 'undefined' && c.user_id !== null) ? c.user_id : '';
          const u = String(rawU).split('.')[0] || '';

          // last_message_at: separar em DATA (YYYY-MM-DD) e HORARIO (HH:MM:SS)
          const rawL = (c && typeof c.last_message_at !== 'undefined' && c.last_message_at !== null) ? String(c.last_message_at) : '';
          let d = '', h = '';
          const m = rawL.match(/^(\d{4}-\d{2}-\d{2})T(\d{2}:\d{2}:\d{2})/); // robusto: ignora fra√ß√µes/offset
          if (m) { d = m[1]; h = m[2]; }

          return [u, d, h];
        });

        const header = 'CLIENTES,DATA,HORARIO\n';
        const esc = s => String(s).replace(/"/g,'""');
        const body = rows.map(([u,d,h]) => `"${esc(u)}","${esc(d)}","${esc(h)}"`).join('\n');
        const csv  = header + body;

        const outName = (file.name.replace(/\.json$/i,'') || 'ROSILANE') + '_export.csv';

        // Reutiliza a UI padr√£o (Downloads + ‚ÄúBaixar todos‚Äù)
        createDownloadLink(outName, csv);
        els.btnDownloadAll.disabled = generatedPacksData.length === 0;

        // limpa o input para permitir reimportar o mesmo arquivo se necess√°rio
        ev.target.value = '';
      }catch(err){
        console.error(err);
        alert('Falha ao exportar CSV: ' + (err.message || err));
      }
    });
  })();

  // ========= PROCESSAR =========
  els.btnProcess.addEventListener('click', async () => {
    if(!selectedFiles.length){ alert('Selecione arquivos ou uma pasta.'); return; }
    const individual = els.modeIndividual.checked;
    const k = Math.max(1, Math.min(40, parseInt(els.packs.value,10) || 1));
    const startAt = Math.max(1, parseInt(els.startIndex.value,10) || 1);

    els.status.textContent = 'Lendo arquivos‚Ä¶';
    els.progress.style.width = '3%';
    generatedPacksData = [];

    const docs = [];
    let processed = 0, charTotal = 0, errors=[];

    for(const file of selectedFiles){
      try{
        let contentRaw = await readFileAsText(file);

        // SEM trim global ‚Äî preserva quebras/ espa√ßos originais
        let content = contentRaw || '';
        content = ensureLf(content);
        content = enforceMaxBlankLines(content);

        const base = baseName(file.name);
        const title = base;
        const h1 = `# ${title}`;

        /* if (els.optimizeMd?.checked) { // comentado
          let md = content;
          md = normalizeBullets(md);
          md = promoteSectionHeadings(md);
          const docId = slugify(base);
          const tags = detectTagsFromName(base);
          const yaml = addFrontMatter({docId, title, source:file.name, tags});
          content = `${yaml}${h1}\n\n${md}`;
        } else { */
          // Comportamento padr√£o: somente H1 no topo
          content = `${h1}\n\n${content}`;
        /* } */

        const len = content.length; 
        charTotal += len;
        docs.push({ name:file.name, content, len });
      }catch(e){ errors.push(`${file.name}: ${e.message}`); }
      processed++;
      if (processed % 10 === 0 || processed === selectedFiles.length) {
        const pctRead = Math.round((processed / selectedFiles.length) * 70); // 0‚Äì70%
        els.progress.style.width = pctRead + '%';
        els.status.textContent = `Lendo arquivos‚Ä¶ (${processed}/${selectedFiles.length})`;
        await new Promise(r=>setTimeout(r, 0));
      }
    }

    els.statChars.textContent = String(charTotal);
    els.statTokens.textContent = String(approxTokens(charTotal));

    if(els.preserveOrder.checked){
      docs.sort((a,b)=> cmpByVersionedName(a.name, b.name));
    }

    // ========== MODO INDIVIDUAL (.txt para cada arquivo) ==========
    if (individual) {
      els.status.textContent = 'Gerando arquivos individuais‚Ä¶';
      els.progress.style.width = '85%';

      els.downloads.innerHTML = '';
      let firstPreview = '';
      const ext = 'txt'; // fixo no individual

      const baseProgress = 70;
      docs.forEach((d, i) => {
        const text = d.content;
        const fname = `${baseName(d.name)}.${ext}`;
        createDownloadLink(fname, text);

        const pct = baseProgress + Math.round(((i+1) / docs.length) * 30);
        els.progress.style.width = pct + '%';

        if (i===0) {
          firstPreview = text.slice(0, 3000) + (text.length>3000 ? '\n‚Ä¶ (cortado)' : '');
        }
      });

      els.btnDownloadAll.disabled = generatedPacksData.length === 0;
      els.preview.textContent = firstPreview || '(vazio)';
      els.progress.style.width = '100%';
      els.status.textContent = `Pronto! ${docs.length} arquivos convertidos.`;

      if(errors.length){
        const pre = document.createElement('pre');
        pre.textContent = 'Arquivos com erro (considere converter .DOC para .DOCX/PDF):\n' + errors.join('\n');
        els.downloads.appendChild(pre);
      }
      return; // encerra aqui no modo individual
    }

    // ========== MODO PACKS ==========
    els.status.textContent = 'Distribuindo documentos‚Ä¶';
    els.progress.style.width = '70%';

    const packs = assignDocsToPacksSequential(docs, k);

    els.downloads.innerHTML = '';
    const forceMd = false; // op√ß√£o ‚ÄúOtimizar para IA‚Äù removida da UI
    const ext = forceMd ? 'md' : els.ext.value;
    const sep = forceMd ? '\n\n---\n\n' : getSeparator();

    let firstPreview = '';

    const baseProgress = 70;
    packs.forEach((pk, i) => {
      const header = `<!-- Pack ${String(i+1).padStart(2,'0')} | arquivos: ${pk.docs.length} | chars: ${pk.len} | tokens‚âà${approxTokens(pk.len)} -->\n\n`;
      const text = header + pk.docs.map(d=>d.content).join(sep);
      const num = String(startAt + i).padStart(2,'0'); // inicia a partir de X
      const fname = `base_de_dados_${num}.${ext}`;
      createDownloadLink(fname, text);

      const pct = baseProgress + Math.round(((i+1) / packs.length) * 30);
      els.progress.style.width = pct + '%';

      if(i===0){
        firstPreview = text.slice(0, 3000) + (text.length>3000 ? '\n‚Ä¶ (cortado)' : '');
      }
    });

    els.btnDownloadAll.disabled = generatedPacksData.length === 0;
    els.preview.textContent = firstPreview || '(vazio)';
    els.progress.style.width = '100%';
    els.status.textContent = `Pronto! ${packs.length} packs gerados.`;

    if(errors.length){
      const pre = document.createElement('pre');
      pre.textContent = 'Arquivos com erro (considere converter .DOC para .DOCX/PDF):\n' + errors.join('\n');
      els.downloads.appendChild(pre);
    }
  });
  </script>
  <script>
(function(){
  const wrap  = document.querySelector('.app-switcher');
  const btn   = document.getElementById('appSwitcherBtn');
  const menu  = document.getElementById('appSwitcherMenu');

  if (!wrap || !btn || !menu) return;

  function toggle(open){
    wrap.classList.toggle('open', open ?? !wrap.classList.contains('open'));
  }

  btn.addEventListener('click', (e)=>{ e.stopPropagation(); toggle(); });

  document.addEventListener('click', (e)=>{
    if (!wrap.contains(e.target)) toggle(false);
  });
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') toggle(false);
  });
})();
</script>

<script>
  (function(){
    const hint = document.querySelector('.help-hint');
    if(!hint) return;
    document.addEventListener('click', (e)=>{
      if(!hint.contains(e.target)){
        // remove o foco do √≠cone, ocultando o pop-up (por CSS)
        hint.blur?.();
      }
    });
  })();
</script>
</body>
</html>
